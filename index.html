<!DOCTYPE html>
<html>
  <head>
    <title>Slides API Quickstart</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Slides API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script type="text/javascript">
      /* exported gapiLoaded */
      /* exported gisLoaded */
      /* exported handleAuthClick */
      /* exported handleSignoutClick */

      // TODO(developer): Set to client ID and API key from the Developer Console
      const CLIENT_ID = '368323697117-1v3jo00lehtsj6kdj02r097ga934v641.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyAPb84Iyn0uBewNM7Oovn0VZ8rpIP1h3tE';

      // Discovery doc URL for APIs used by the quickstart
      const DISCOVERY_DOC = 'https://slides.googleapis.com/$discovery/rest?version=v1';

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      const SCOPES = 'https://www.googleapis.com/auth/presentations';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
        // gapi.load('client', () => {
        //     createPresentation('Askkhonsu-Custom-Travel-Plan', createSlide);
        // });
      }

      /**
       * Callback after the API client is loaded. Loads the
       * discovery doc to initialize the API.
       */
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
        // createPresentation('Askkhonsu-Custom-Travel-Plan', createSlide);
      }

      /**
       * Callback after Google Identity Services are loaded.
       */
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
        // createPresentation('Askkhonsu-Custom-Travel-Plan', createSlide);
      }

      /**
       * Enables user interaction after all libraries are loaded.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
          await listSlides();

          const imgUrls = ['https://assets-global.website-files.com/61268cc8812ac5956bad13e4/65224587d4a92133be28cf73_Printed%20Khonsu%20Tailored%20Plan%20-%20TEMPLATE.png',
                            'https://assets-global.website-files.com/61268cc8812ac5956bad13e4/64ab6212f0f29612f2cfd8f9_Central%20Park%20lake%20couple.jpg',
                            'https://assets-global.website-files.com/61268cc8812ac5956bad13e4/654d862321c5794682d467d0_Statue%20Of%20Liberty.jpg'];

          // const templatePresentationId = '1PhHqb2lYMlcoi-6snsyt1cf9xH2r8nnv2vd7UE3nbxM';  
          const templatePresentationId = '1s5zRdIWAFWbzxxriB-3NniCCj7WBKFmEBrtsN_R0Cn0';                      

          await createPresentation('Askkhonsu-Custom-Travel-Plan', async (id)=>{

            // textMerging(templatePresentationId, ()=>{
            //   console.log('ran yes 2....')
            // });

            textMerging(templatePresentationId, id, ()=>{
              console.log('ran yes 3....')
            });

            // for (let i = 0; i < 3 ; i++) {
            //   await createSlide(id, async (createSlideResponse)=>{
            //     await createImage(createSlideResponse, imgUrls[i]); 
            //   }); 
            // }

            // const presentationId = id; 

            // for await (const url of imgUrls) {
            //   await createSlide(presentationId, async (createSlideResponse)=>{
            //     await createTextboxWithText(createSlideResponse);
            //     await createImage(createSlideResponse, url); 
            //   }); 
            // }

            
          });
          // await createPresentation('Askkhonsu-Custom-Travel-Plan2', undefined);

        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content').innerText = '';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
        }
      }

      /**
       * Prints the number of slides and elements in a sample presentation:
       * https://docs.google.com/presentation/d/1EAYk18WDjIG-zp_0vLm3CsfQh_i8eXc67Jo2O9C6Vuc/edit
       */
      async function listSlides() {
        let response;
        try {
          response = await gapi.client.slides.presentations.get({
            presentationId: '1EAYk18WDjIG-zp_0vLm3CsfQh_i8eXc67Jo2O9C6Vuc',
          });
        } catch (err) {
          document.getElementById('content').innerText = err.message;
          return;
        }
        const presentation = response.result;
        if (!presentation || !presentation.slides || presentation.slides.length == 0) {
          document.getElementById('content').innerText = 'No slides found.';
          return;
        }
        // Flatten to string to display
        const output = presentation.slides.reduce(
            (str, slide, index) => {
              const numElements = slide.pageElements.length;
              return `${str}- Slide #${index} contains ${numElements} elements\n`;
            },
            'Slides:\n');
        document.getElementById('content').innerText = output;
      }

      async function createPresentation(title, callback) {
        try {
            gapi.client.slides.presentations.create({
                title: title,
            }).then((response) => {
                console.log(`Created presentation with ID: ${response.result.presentationId}`, '(createPresentation) Full response:\n', response);
                const id = response.result.presentationId; 
                if (callback) callback(id, callback);
            });
        } catch (err) {
            // document.getElementById('content').innerText = err.message;
            console.log(`Error: ${err.message}`)
            return;
        }
      } 

      async function createSlide(presentationId, callback) {
        const requests = [
            {
            createSlide: {
                // objectId: pageId,
                insertionIndex: '1',
                slideLayoutReference: {
                predefinedLayout: 'TITLE_AND_TWO_COLUMNS',
                },
            },
            },
        ];
        // If you wish to populate the slide with elements, add element create requests here,
        // using the pageId.
        // Execute the request.
        try {
            gapi.client.slides.presentations
                .batchUpdate({
                  presentationId: presentationId,
                  requests: requests,
                })
                .then((createSlideResponse) => {
                  const objectId =
                  createSlideResponse.result.replies[0].createSlide.objectId;
                  console.log(`Created slide with ID: ${objectId}`, '(createSlide) Full response:\n', createSlideResponse); 
                  return callback(createSlideResponse); 
                });
        } catch (err) {
            // document.getElementById('content').innerText = err.message;
            console.log(`Error: ${err.message}`)
            return;
        }
      }      

      // function createImage(presentationId, pageId, IMAGE_URL, callback) {
        async function createImage(createSlideResponse, IMAGE_URL, callback) {
          console.log('Just ran createImage') 
        const {
          result: {
            presentationId,
            replies: [
              { 
                createSlide: {
                  objectId: pageId
                }
              }
            ], 
          },
        } = createSlideResponse; 

        // console.log(`presentationId: ${presentationId} \n objectId: ${pageId}`)
        
        const imageUrl = IMAGE_URL;
        // const imageUrl = 'https://assets-global.website-files.com/61268cc8812ac5956bad13e4/64920afe42b4f65d85b22cb6_man%20standing%20on%20road%20infront%20of%20high-rise%20buildi.webp';
        // const imageUrl = 'https://assets-global.website-files.com/61268cc8812ac5956bad13e4/65224587d4a92133be28cf73_Printed%20Khonsu%20Tailored%20Plan%20-%20TEMPLATE.png';
        // const imageUrl2 = 'https://assets-global.website-files.com/61268cc8812ac5956bad13e4/654d862321c5794682d467d0_Statue%20Of%20Liberty.jpg';
        // const imageUrl3 = 'https://assets-global.website-files.com/61268cc8812ac5956bad13e4/64ab6212f0f29612f2cfd8f9_Central%20Park%20lake%20couple.jpg';

        // Create a new image, using the supplied object ID, with content downloaded from imageUrl.
        const requests = [];
        const imageId = 'MyImage_02';
        const emu4M = {
            magnitude: 4000000,
            unit: 'EMU',
        };
        requests.push({
            createImage: {
              objectId: imageId,
              url: imageUrl,
              elementProperties: {
                  pageObjectId: pageId,
                  size: {
                    height: emu4M,
                    width: emu4M,
                  },
                  transform: {
                    scaleX: 1,
                    scaleY: 1,
                    translateX: 100000,
                    translateY: 100000,
                    unit: 'EMU',
                  },
              },
            },
        });
        // Execute the request. 
        try { 
            await gapi.client.slides.presentations.batchUpdate({
              presentationId: presentationId,
              requests: requests,
            }).then((response) => {
              const createImageResponse = response.result.replies;
              console.log(`Created image with ID: ${createImageResponse[0].createImage.objectId}`, '(createImage) Full response:\n', createImageResponse);
              if (callback) callback(createImageResponse);
            });
        } catch (err) {
            document.getElementById('content').innerText = err.message;
            return;
        }
      }
      
      
      // setTimeout(() => {
      //   // createPresentation('Askkhonsu-Custom-Travel-Plan', undefined);
      //   console.log('Ran.....'); 

      //   gapi.client.slides.presentations.create({
      //       title: 'Askkhonsu-Custom-Travel-Plan',
      //   }).then((response) => {
      //     console.log('response:', response)
      //   });

      // }, 30000);

      function createTextboxWithText(createSlideResponse) {
        const {
          result: {
            presentationId,
            replies: [
              { 
                createSlide: {
                  objectId: pageId
                }
              }
            ], 
          },
        } = createSlideResponse; 
        // Create a new square textbox, using the supplied element ID.
        const elementId = 'MyTextBox_01';
        const pt350 = {
          magnitude: 350,
          unit: 'PT',
        };
        const requests = [{
          createShape: {
            objectId: elementId,
            shapeType: 'TEXT_BOX',
            elementProperties: {
              pageObjectId: pageId,
              size: {
                height: pt350,
                width: pt350,
              },
              transform: {
                scaleX: 1,
                scaleY: 1,
                translateX: 350,
                translateY: 100,
                unit: 'PT',
              },
            },
          },
        },

        // Insert text into the box, using the supplied element ID.
        {
          insertText: {
            objectId: elementId,
            insertionIndex: 0,
            text: 'New Box Text Inserted!',
          },
        }];
        // Execute the request.
        try {
          gapi.client.slides.presentations.batchUpdate({
            presentationId: presentationId,
            requests: requests,
          }).then((createTextboxWithTextResponse) => {
            const createShapeResponse = createTextboxWithTextResponse.result.replies[0].createShape;
            console.log(`Created textbox with ID: ${createShapeResponse.objectId}`);
            if (callback) callback(createTextboxWithTextResponse.result);
          });
        } catch (err) {
          document.getElementById('content').innerText = err.message;
          return;
        }
      }


      

      // function textMerging(templatePresentationId, dataSpreadsheetId, callback) {
      function textMerging(templatePresentationId, presentationCopyId, callback) {
        // Use the Sheets API to load data, one record per row.
        const responses = [];
        const dataRangeNotation = 'Customers!A2:M6';
        try {
          // gapi.client.sheets.spreadsheets.values.get({
          //   spreadsheetId: dataSpreadsheetId,
          //   range: dataRangeNotation,
          // }).then((sheetsResponse) => {
            // const values = sheetsResponse.result.values;
            // For each record, create a new merged presentation.


            const values = [
              ['Jes', 'A guy', 'Dev'],
              // ['Mui', 'A guy', 'Designer'],
              // ['KK', 'A gal', 'Dev'],
            ];

            for (let i = 0; i < values.length; ++i) {
              const row = values[i];
              const customerName = row[0]; // name in column 3
              const caseDescription = row[1]; // case description in column 6
              const totalPortfolio = row[2]; // total portfolio in column 12

              console.log(`customerName: ${customerName} \n caseDescription: ${caseDescription} \n totalPortfolio: ${totalPortfolio}`)

              // Duplicate the template presentation using the Drive API.
              const copyTitle = customerName + ' presentation';
              const request = {
                name: copyTitle,
              };

              // gapi.client.drive.files.copy({
              //   fileId: templatePresentationId,
              //   requests: request,
              // }).then((driveResponse) => {
                // const presentationCopyId = driveResponse.result.id;

                // Create the text merge (replaceAllText) requests for this presentation.
                const requests = [{
                  replaceAllText: {
                    containsText: {
                      text: '{{customer-name}}',
                      matchCase: true,
                    },
                    replaceText: customerName,
                  },
                }, {
                  replaceAllText: {
                    containsText: {
                      text: '{{case-description}}',
                      matchCase: true,
                    },
                    replaceText: caseDescription,
                  },
                }, {
                  replaceAllText: {
                    containsText: {
                      text: '{{total-portfolio}}',
                      matchCase: true,
                    },
                    replaceText: totalPortfolio,
                  },
                }];

                // Execute the requests for this presentation.
                gapi.client.slides.presentations.batchUpdate({
                  // presentationId: presentationCopyId,
                  presentationId: presentationCopyId,
                  requests: requests,
                }).then((batchUpdateResponse) => {
                  const result = batchUpdateResponse.result;

                  console.log('requests:', requests, '\nresult:', result) 

                  responses.push(result.replies);
                  // Count the total number of replacements made.
                  let numReplacements = 0;
                  for (let i = 0; i < result.replies.length; ++i) {
                    numReplacements += result.replies[i].replaceAllText.occurrencesChanged;
                  }
                  console.log(`Created presentation for ${customerName} with ID: ${presentationCopyId}`);
                  console.log(`Replaced ${numReplacements} text instances`);
                  if (responses.length === values.length) { // callback for the last value
                    if (callback) callback(responses);
                  }
                });


              // });


            }


          // });
        } catch (err) {
          document.getElementById('content').innerText = err.message;
          return;
        }
      }

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>  